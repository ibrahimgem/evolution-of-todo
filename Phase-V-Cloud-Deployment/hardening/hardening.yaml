# Phase V: Enterprise Cloud Deployment
# Production Hardening Configuration
#
# [Task]: T051-T060
# [From]: speckit.specify ยง3.6, speckit.plan ยง2.6

---
# =============================================================================
# SECTION 1: HORIZONTAL POD AUTOSCALER (HPA)
# =============================================================================

# Frontend HPA
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: todo-chatbot-frontend-hpa
  namespace: default
  labels:
    app.kubernetes.io/name: todo-chatbot-frontend
    app.kubernetes.io/part-of: todo-chatbot
    app.kubernetes.io/component: frontend
    hardening.todo.chatbot/enabled: "true"
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: todo-chatbot-frontend
  minReplicas: 3
  maxReplicas: 20
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
    - type: Pods
      pods:
        metric:
          name: http_requests_per_second
        target:
          type: AverageValue
          averageValue: "100"
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
        - type: Percent
          value: 100
          periodSeconds: 60
        - type: Pods
          value: 4
          periodSeconds: 60
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 10
          periodSeconds: 60
        - type: Pods
          value: 1
          periodSeconds: 120
      selectPolicy: Min

# Backend HPA
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: todo-chatbot-backend-hpa
  namespace: default
  labels:
    app.kubernetes.io/name: todo-chatbot-backend
    app.kubernetes.io/part-of: todo-chatbot
    app.kubernetes.io/component: backend
    hardening.todo.chatbot/enabled: "true"
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: todo-chatbot-backend
  minReplicas: 3
  maxReplicas: 20
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
    - type: Pods
      pods:
        metric:
          name: http_request_duration_seconds
        target:
          type: AverageValue
          averageValue: "500m"
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
        - type: Percent
          value: 100
          periodSeconds: 60
        - type: Pods
          value: 4
          periodSeconds: 60
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 10
          periodSeconds: 60
        - type: Pods
          value: 1
          periodSeconds: 120
      selectPolicy: Min

# Kafka HPA
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: kafka-hpa
  namespace: kafka
  labels:
    app.kubernetes.io/name: kafka
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: todo-chatbot-kafka
  minReplicas: 3
  maxReplicas: 6
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 120
      policies:
        - type: Percent
          value: 50
          periodSeconds: 120
    scaleDown:
      stabilizationWindowSeconds: 600
      policies:
        - type: Percent
          value: 10
          periodSeconds: 300

# Redis HPA
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: redis-hpa
  namespace: default
  labels:
    app.kubernetes.io/name: redis
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: redis
  minReplicas: 1
  maxReplicas: 3
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80

# Monitoring HPA
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: prometheus-hpa
  namespace: monitoring
  labels:
    app.kubernetes.io/name: prometheus
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: prometheus
  minReplicas: 2
  maxReplicas: 5
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80

# Grafana HPA
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: grafana-hpa
  namespace: monitoring
  labels:
    app.kubernetes.io/name: grafana
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: grafana
  minReplicas: 2
  maxReplicas: 3
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80

---
# =============================================================================
# SECTION 2: ROLE-BASED ACCESS CONTROL (RBAC)
# =============================================================================

# Frontend Service Account with minimal permissions
apiVersion: v1
kind: ServiceAccount
metadata:
  name: todo-chatbot-frontend
  namespace: default
  labels:
    app.kubernetes.io/name: todo-chatbot-frontend
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
  annotations:
    kubernetes.io/service-account.name: todo-chatbot-frontend

# Backend Service Account with database permissions
apiVersion: v1
kind: ServiceAccount
metadata:
  name: todo-chatbot-backend
  namespace: default
  labels:
    app.kubernetes.io/name: todo-chatbot-backend
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
  annotations:
    kubernetes.io/service-account.name: todo-chatbot-backend

# Frontend Role - Read-only access to configmaps and secrets
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: todo-chatbot-frontend
  namespace: default
  labels:
    app.kubernetes.io/name: todo-chatbot-frontend
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
rules:
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list"]
  - apiGroups: [""]
    resources: ["pods", "services"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["dapr.io"]
    resources: ["components"]
    verbs: ["get", "list"]

# Backend Role - Full CRUD on application resources
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: todo-chatbot-backend
  namespace: default
  labels:
    app.kubernetes.io/name: todo-chatbot-backend
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
rules:
  - apiGroups: [""]
    resources: ["configmaps", "secrets", "pods", "services", "endpoints"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: ["dapr.io"]
    resources: ["components", "configurations", "subscriptions"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["apps"]
    resources: ["deployments"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["get", "list", "watch", "create", "patch"]

# Frontend RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: todo-chatbot-frontend
  namespace: default
  labels:
    app.kubernetes.io/name: todo-chatbot-frontend
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: todo-chatbot-frontend
subjects:
  - kind: ServiceAccount
    name: todo-chatbot-frontend
    namespace: default

# Backend RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: todo-chatbot-backend
  namespace: default
  labels:
    app.kubernetes.io/name: todo-chatbot-backend
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: todo-chatbot-backend
subjects:
  - kind: ServiceAccount
    name: todo-chatbot-backend
    namespace: default

# ClusterRole for monitoring (read-only)
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: todo-chatbot-monitoring
  labels:
    app.kubernetes.io/name: todo-chatbot-monitoring
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
rules:
  - apiGroups: [""]
    resources: ["nodes", "pods", "services", "endpoints", "configmaps"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["apps"]
    resources: ["deployments", "statefulsets", "daemonsets", "replicasets"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["networking.k8s.io"]
    resources: ["ingresses", "networkpolicies"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["monitoring.coreos.com"]
    resources: ["prometheuses", "servicemonitors", "podmonitors"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["resourcequotas", "limitranges"]
    verbs: ["get", "list", "watch"]

# ClusterRoleBinding for monitoring
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: todo-chatbot-monitoring
  labels:
    app.kubernetes.io/name: todo-chatbot-monitoring
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: todo-chatbot-monitoring
subjects:
  - kind: ServiceAccount
    name: prometheus
    namespace: monitoring
  - kind: ServiceAccount
    name: grafana
    namespace: monitoring

---
# =============================================================================
# SECTION 3: SECURITY POLICIES (PSA)
# =============================================================================

# Pod Security Standards - Baseline
apiVersion: v1
kind: Namespace
metadata:
  name: default
  labels:
    name: default
    kubernetes.io/metadata.name: default
    pod-security.kubernetes.io/enforce: baseline
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/warn: restricted

# Kafka Namespace - Baseline
apiVersion: v1
kind: Namespace
metadata:
  name: kafka
  labels:
    name: kafka
    kubernetes.io/metadata.name: kafka
    pod-security.kubernetes.io/enforce: baseline
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/warn: restricted

# Monitoring Namespace - Privileged (for monitoring tools)
apiVersion: v1
kind: Namespace
metadata:
  name: monitoring
  labels:
    name: monitoring
    kubernetes.io/metadata.name: monitoring
    pod-security.kubernetes.io/enforce: privileged
    pod-security.kubernetes.io/audit: privileged
    pod-security.kubernetes.io/warn: privileged

---
# =============================================================================
# SECTION 4: NETWORK POLICIES
# =============================================================================

# Default Deny Policy for Default Namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny
  namespace: default
  labels:
    app.kubernetes.io/name: default-deny
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress

# Frontend Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: todo-chatbot-frontend
  namespace: default
  labels:
    app.kubernetes.io/name: todo-chatbot-frontend
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: todo-chatbot-frontend
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
      ports:
        - protocol: TCP
          port: 3000
    - from:
        - namespaceSelector:
            matchLabels:
              name: dapr-system
      ports:
        - protocol: TCP
          port: 3500
    - from:
        - namespaceSelector:
            matchLabels:
              name: monitoring
      ports:
        - protocol: TCP
          port: 9090
  egress:
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: todo-chatbot-backend
      ports:
        - protocol: TCP
          port: 3000
        - protocol: TCP
          port: 3500
    - to:
        - namespaceSelector:
            matchLabels:
              name: dapr-system
      ports:
        - protocol: TCP
          port: 80
        - protocol: TCP
          port: 50001
        - protocol: TCP
          port: 50002
        - protocol: TCP
          port: 9090
    - to:
        - namespaceSelector:
            matchLabels:
              name: monitoring
      ports:
        - protocol: TCP
          port: 14250
        - protocol: TCP
          port: 9411
    - to: []
      ports:
        - protocol: UDP
          port: 53

# Backend Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: todo-chatbot-backend
  namespace: default
  labels:
    app.kubernetes.io/name: todo-chatbot-backend
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: todo-chatbot-backend
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: todo-chatbot-frontend
      ports:
        - protocol: TCP
          port: 3000
        - protocol: TCP
          port: 50001
    - from:
        - namespaceSelector:
            matchLabels:
              name: dapr-system
      ports:
        - protocol: TCP
          port: 3500
        - protocol: TCP
          port: 50001
        - protocol: TCP
          port: 50002
        - protocol: TCP
          port: 9090
    - from:
        - namespaceSelector:
            matchLabels:
              name: monitoring
      ports:
        - protocol: TCP
          port: 9090
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              name: kafka
      ports:
        - protocol: TCP
          port: 9093
    - to:
        - podSelector:
            matchLabels:
              app: redis
      ports:
        - protocol: TCP
          port: 6379
    - to:
        - namespaceSelector:
            matchLabels:
              name: dapr-system
      ports:
        - protocol: TCP
          port: 80
        - protocol: TCP
          port: 50001
        - protocol: TCP
          port: 50002
        - protocol: TCP
          port: 9090
    - to:
        - namespaceSelector:
            matchLabels:
              name: monitoring
      ports:
        - protocol: TCP
          port: 14250
        - protocol: TCP
          port: 9411
    - to: []
      ports:
        - protocol: TCP
          port: 443  # HTTPS for OpenAI API
        - protocol: UDP
          port: 53

# Kafka Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: kafka
  namespace: kafka
  labels:
    app.kubernetes.io/name: kafka
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
spec:
  podSelector:
    matchLabels:
      strimzi.io/name: todo-chatbot-kafka
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: default
      ports:
        - protocol: TCP
          port: 9092
        - protocol: TCP
          port: 9093
        - protocol: TCP
          port: 9094
    - from:
        - namespaceSelector:
            matchLabels:
              name: monitoring
      ports:
        - protocol: TCP
          port: 9090
  egress:
    - to: []
      ports:
        - protocol: TCP
          port: 9092
        - protocol: TCP
          port: 9093
        - protocol: UDP
          port: 53

# Monitoring Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: monitoring
  namespace: monitoring
  labels:
    app.kubernetes.io/name: monitoring
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: default
      ports:
        - protocol: TCP
          port: 9090  # Prometheus
        - protocol: TCP
          port: 3100  # Loki
        - protocol: TCP
          port: 16686 # Jaeger
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
      ports:
        - protocol: TCP
          port: 9090
        - protocol: TCP
          port: 3000  # Grafana
        - protocol: TCP
          port: 16686 # Jaeger
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              name: default
      ports:
        - protocol: TCP
          port: 10250  # Kubelet
    - to: []
      ports:
        - protocol: UDP
          port: 53

---
# =============================================================================
# SECTION 5: RESOURCE QUOTAS
# =============================================================================

# ResourceQuota for Default Namespace
apiVersion: v1
kind: ResourceQuota
metadata:
  name: todo-chatbot-quota
  namespace: default
  labels:
    app.kubernetes.io/name: todo-chatbot-quota
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
spec:
  hard:
    cpu: "20"
    memory: 40Gi
    pods: "50"
    services: "10"
    secrets: "20"
    configmaps: "30"
    persistentvolumeclaims: "10"
    replicationcontrollers: "10"

# ResourceQuota for Kafka Namespace
apiVersion: v1
kind: ResourceQuota
metadata:
  name: kafka-quota
  namespace: kafka
  labels:
    app.kubernetes.io/name: kafka-quota
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
spec:
  hard:
    cpu: "30"
    memory: 60Gi
    pods: "20"
    services: "10"
    persistentvolumeclaims: "10"

# LimitRange for Default Namespace
apiVersion: v1
kind: LimitRange
metadata:
  name: todo-chatbot-limits
  namespace: default
  labels:
    app.kubernetes.io/name: todo-chatbot-limits
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
spec:
  limits:
    - type: Container
      max:
        cpu: "2000m"
        memory: "2Gi"
      min:
        cpu: "50m"
        memory: "64Mi"
      default:
        cpu: "100m"
        memory: "128Mi"
      defaultRequest:
        cpu: "100m"
        memory: "128Mi"
    - type: Pod
      max:
        cpu: "4000m"
        memory: "4Gi"
      min:
        cpu: "100m"
        memory: "128Mi"

---
# =============================================================================
# SECTION 6: SECURITY CONTEXTS
# =============================================================================

# Frontend Security Context
apiVersion: v1
kind: ConfigMap
metadata:
  name: frontend-security-context
  namespace: default
  labels:
    app.kubernetes.io/name: frontend-security-context
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
data:
  security-context.yaml: |
    securityContext:
      runAsNonRoot: true
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop:
          - ALL
      seccompProfile:
        type: RuntimeDefault

# Backend Security Context
apiVersion: v1
kind: ConfigMap
metadata:
  name: backend-security-context
  namespace: default
  labels:
    app.kubernetes.io/name: backend-security-context
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
data:
  security-context.yaml: |
    securityContext:
      runAsNonRoot: true
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop:
          - ALL
      seccompProfile:
        type: RuntimeDefault

---
# =============================================================================
# SECTION 7: POD DISRUPTION BUDGETS (PDB)
# =============================================================================

# Frontend PDB
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: todo-chatbot-frontend-pdb
  namespace: default
  labels:
    app.kubernetes.io/name: todo-chatbot-frontend-pdb
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: todo-chatbot-frontend

# Backend PDB
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: todo-chatbot-backend-pdb
  namespace: default
  labels:
    app.kubernetes.io/name: todo-chatbot-backend-pdb
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: todo-chatbot-backend

# Kafka PDB
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: kafka-pdb
  namespace: kafka
  labels:
    app.kubernetes.io/name: kafka-pdb
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
spec:
  minAvailable: 2
  selector:
    matchLabels:
      strimzi.io/name: todo-chatbot-kafka

# Redis PDB
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: redis-pdb
  namespace: default
  labels:
    app.kubernetes.io/name: redis-pdb
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: redis

# Prometheus PDB
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: prometheus-pdb
  namespace: monitoring
  labels:
    app.kubernetes.io/name: prometheus-pdb
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: prometheus

# Grafana PDB
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: grafana-pdb
  namespace: monitoring
  labels:
    app.kubernetes.io/name: grafana-pdb
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: grafana

---
# =============================================================================
# SECTION 8: BACKUP STRATEGY
# =============================================================================

# Backup CronJob for Database
apiVersion: batch/v1
kind: CronJob
metadata:
  name: database-backup
  namespace: default
  labels:
    app.kubernetes.io/name: database-backup
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
spec:
  schedule: "0 2 * * *"  # Daily at 2 AM
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 7
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/name: database-backup
        spec:
          serviceAccountName: todo-chatbot-backend
          containers:
            - name: backup
              image: postgres:15-alpine
              command:
                - /bin/sh
                - -c
                - |
                  pg_dump -h $POSTGRES_HOST -U $POSTGRES_USER $POSTGRES_DB | gzip > /backup/db-$(date +%Y%m%d-%H%M%S).sql.gz
                  aws s3 cp /backup/db-*.sql.gz s3://$BACKUP_BUCKET/database/ --storage-class STANDARD-IA
                  find /backup -name "db-*.sql.gz" -mtime +7 -delete
              env:
                - name: POSTGRES_HOST
                  valueFrom:
                    secretKeyRef:
                      name: todo-chatbot-secrets
                      key: database-host
                - name: POSTGRES_USER
                  valueFrom:
                    secretKeyRef:
                      name: todo-chatbot-secrets
                      key: database-user
                - name: POSTGRES_DB
                  value: "todo_chatbot"
                - name: BACKUP_BUCKET
                  value: "todo-chatbot-backups"
              volumeMounts:
                - name: backup-storage
                  mountPath: /backup
              resources:
                requests:
                  memory: "64Mi"
                  cpu: "50m"
                limits:
                  memory: "128Mi"
                  cpu: "100m"
              securityContext:
                runAsNonRoot: true
                runAsUser: 1000
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                capabilities:
                  drop:
                    - ALL
          volumes:
            - name: backup-storage
              emptyDir: {}
          restartPolicy: OnFailure

# Backup CronJob for Redis
apiVersion: batch/v1
kind: CronJob
metadata:
  name: redis-backup
  namespace: default
  labels:
    app.kubernetes.io/name: redis-backup
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
spec:
  schedule: "0 3 * * *"  # Daily at 3 AM
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 7
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/name: redis-backup
        spec:
          containers:
            - name: backup
              image: redis:7-alpine
              command:
                - /bin/sh
                - -c
                - |
                  redis-cli BGSAVE
                  while [ $(redis-cli LASTSAVE) == $(redis-cli LASTSAVE) ]; do sleep 1; done
                  redis-cli SAVE
                  cp /data/dump.rdb /backup/redis-$(date +%Y%m%d-%H%M%S).rdb
                  gzip /backup/redis-*.rdb
                  aws s3 cp /backup/redis-*.rdb.gz s3://$BACKUP_BUCKET/redis/ --storage-class STANDARD-IA
                  find /backup -name "redis-*.rdb.gz" -mtime +7 -delete
              env:
                - name: BACKUP_BUCKET
                  value: "todo-chatbot-backups"
              volumeMounts:
                - name: backup-storage
                  mountPath: /backup
                - name: redis-data
                  mountPath: /data
              resources:
                requests:
                  memory: "64Mi"
                  cpu: "50m"
                limits:
                  memory: "128Mi"
                  cpu: "100m"
              securityContext:
                runAsNonRoot: true
                runAsUser: 1000
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                capabilities:
                  drop:
                    - ALL
          volumes:
            - name: backup-storage
              emptyDir: {}
            - name: redis-data
              persistentVolumeClaim:
                claimName: redis-pvc
          restartPolicy: OnFailure

# Backup Storage Secret
apiVersion: v1
kind: Secret
metadata:
  name: backup-credentials
  namespace: default
  labels:
    app.kubernetes.io/name: backup-credentials
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
type: Opaque
data:
  aws-access-key-id: <base64-encoded>
  aws-secret-access-key: <base64-encoded>

---
# =============================================================================
# SECTION 9: SERVICE MESH CONFIGURATION (Optional)
# =============================================================================

# Istio PeerAuthentication for mTLS
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: mtls-strict
  namespace: default
  labels:
    app.kubernetes.io/name: mtls-strict
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
spec:
  mtls:
    mode: STRICT

# Istio AuthorizationPolicy for Frontend
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: todo-chatbot-frontend-auth
  namespace: default
  labels:
    app.kubernetes.io/name: todo-chatbot-frontend-auth
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: todo-chatbot-frontend
  action: ALLOW
  rules:
    - from:
        - source:
            principals: ["cluster.local/ns/ingress-nginx/serviceaccounts/default"]
        - source:
            principals: ["cluster.local/ns/dapr-system/serviceaccounts/dapr-sidecar-injector"]
    - to:
        - operation:
            ports: ["3000", "3500"]

# Istio AuthorizationPolicy for Backend
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: todo-chatbot-backend-auth
  namespace: default
  labels:
    app.kubernetes.io/name: todo-chatbot-backend-auth
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: todo-chatbot-backend
  action: ALLOW
  rules:
    - from:
        - source:
            principals: ["cluster.local/ns/default/serviceaccounts/todo-chatbot-frontend"]
        - source:
            principals: ["cluster.local/ns/dapr-system/serviceaccounts/dapr-sidecar-injector"]
    - to:
        - operation:
            ports: ["3000", "3500", "50001"]

---
# =============================================================================
# SECTION 10: AUDIT LOGGING
# =============================================================================

# Kubernetes Audit Policy
apiVersion: v1
kind: ConfigMap
metadata:
  name: audit-policy
  namespace: kube-system
  labels:
    app.kubernetes.io/name: audit-policy
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
data:
  policy.yaml: |
    apiVersion: audit.k8s.io/v1
    kind: Policy
    rules:
      # System-level resources (watch all)
      - level: Metadata
        resources:
          - group: ""
            resources: ["pods", "services", "endpoints"]
          - group: "apps"
            resources: ["deployments", "statefulsets", "daemonsets"]
        omitStages:
          - RequestReceived

      # Sensitive operations
      - level: RequestResponse
        resources:
          - group: ""
            resources: ["secrets", "configmaps"]
          - group: "authentication.k8s.io"
            resources: ["tokenreviews"]
        omitStages:
          - RequestReceived

      # Read-only operations
      - level: ReadOnly
        resources:
          - group: ""
            resources: ["pods/log", "pods/status"]
        omitStages:
          - RequestReceived

      # Default catch-all
      - level: Metadata
        omitStages:
          - RequestReceived

# Audit Webhook Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: audit-webhook
  namespace: kube-system
  labels:
    app.kubernetes.io/name: audit-webhook
    app.kubernetes.io/part-of: todo-chatbot
    hardening.todo.chatbot/enabled: "true"
data:
  webhook-config.yaml: |
    apiVersion: v1
    kind: Config
    clusters:
      - name: audit-logging
        cluster:
          server: http://audit-collector:9411/v1/logs
    contexts:
      - name: audit-logging
        context:
          cluster: audit-logging
          user: audit-collector
    current-context: audit-logging
