# Phase V: Enterprise Cloud Deployment
# Dapr Control Plane Installation for Microservices Patterns
#
# [Task]: T021
# [From]: speckit.specify ยง3.3, speckit.plan ยง2.3

---
# Dapr Control Plane Namespace
apiVersion: v1
kind: Namespace
metadata:
  name: dapr-system
  labels:
    name: dapr-system
    app.kubernetes.io/name: dapr
    app.kubernetes.io/part-of: todo-chatbot
---
# Dapr Control Plane Components
---
# Dapr Operator
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dapr-operator
  namespace: dapr-system
  labels:
    app: dapr-operator
    app.kubernetes.io/name: dapr-operator
    app.kubernetes.io/part-of: todo-chatbot
    app.kubernetes.io/version: "1.12.0"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dapr-operator
  template:
    metadata:
      labels:
        app: dapr-operator
      annotations:
        dapr.io/enabled: "false"  # Don't inject Dapr into itself
    spec:
      serviceAccountName: dapr-operator
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
      containers:
        - name: dapr-operator
          image: "docker.io/daprio/dapr:1.12.0"
          imagePullPolicy: IfNotPresent
          command: ["/usr/local/bin/daprd"]
          args:
            - "--mode=kubernetes"
            - "--dapr-http-port=80"
            - "--dapr-grpc-port=50001"
            - "--dapr-internal-grpc-port=50002"
            - "--app-port=8080"
            - "--app-id=dapr-operator"
            - "--control-plane-address=dapr-api.dapr-system.svc.cluster.local:80"
            - "--log-level=info"
            - "--log-as-json"
            - "--metrics-port=9090"
            - "--enable-metrics=true"
            - "--namespace=dapr-system"
            - "--image-pull-policy=Always"
            - "--enable-mtls=true"
            - "--issuer-timeout=30s"
            - "--leader-election=true"
            - "--leader-election-id=dapr-operator-leader-election"
            - "--validating-webhook-timeout=30s"
            - "--mutating-webhook-timeout=30s"
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: DAPR_API_TOKEN
              valueFrom:
                secretKeyRef:
                  name: dapr-api-token
                  key: dapr-api-token
          ports:
            - containerPort: 80
              name: http
              protocol: TCP
            - containerPort: 50001
              name: grpc
              protocol: TCP
            - containerPort: 50002
              name: internal-grpc
              protocol: TCP
            - containerPort: 9090
              name: metrics
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /healthz
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 5
          readinessProbe:
            httpGet:
              path: /healthz
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          workingDir: /home/nonroot
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
      volumes:
        - name: dapr-trust-bundle
          secret:
            secretName: dapr-trust-bundle
      restartPolicy: Always
      terminationGracePeriodSeconds: 30
      securityContext:
        fsGroup: 1001

---
# Dapr API Service
apiVersion: v1
kind: Service
metadata:
  name: dapr-api
  namespace: dapr-system
  labels:
    app: dapr-api
    app.kubernetes.io/name: dapr-api
    app.kubernetes.io/part-of: todo-chatbot
    app.kubernetes.io/version: "1.12.0"
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 80
      targetPort: http
      protocol: TCP
    - name: grpc
      port: 50001
      targetPort: grpc
      protocol: TCP
    - name: internal-grpc
      port: 50002
      targetPort: internal-grpc
      protocol: TCP
    - name: metrics
      port: 9090
      targetPort: metrics
      protocol: TCP
  selector:
    app: dapr-operator

---
# Dapr Sidecar Injector
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dapr-sidecar-injector
  namespace: dapr-system
  labels:
    app: dapr-sidecar-injector
    app.kubernetes.io/name: dapr-sidecar-injector
    app.kubernetes.io/part-of: todo-chatbot
    app.kubernetes.io/version: "1.12.0"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dapr-sidecar-injector
  template:
    metadata:
      labels:
        app: dapr-sidecar-injector
      annotations:
        dapr.io/enabled: "false"  # Don't inject Dapr into itself
    spec:
      serviceAccountName: dapr-sidecar-injector
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
      containers:
        - name: dapr-sidecar-injector
          image: "docker.io/daprio/dapr:1.12.0"
          imagePullPolicy: IfNotPresent
          command: ["/usr/local/bin/daprd"]
          args:
            - "--mode=kubernetes"
            - "--dapr-http-port=80"
            - "--dapr-grpc-port=50001"
            - "--dapr-internal-grpc-port=50002"
            - "--app-port=8080"
            - "--app-id=dapr-sidecar-injector"
            - "--control-plane-address=dapr-api.dapr-system.svc.cluster.local:80"
            - "--log-level=info"
            - "--log-as-json"
            - "--metrics-port=9090"
            - "--enable-metrics=true"
            - "--namespace=dapr-system"
            - "--image-pull-policy=Always"
            - "--enable-mtls=true"
            - "--sidecar-injector-enabled=true"
            - "--sidecar-injector-port=4000"
            - "--sidecar-injector-webhook-port=4000"
            - "--trust-anchors-file=/var/run/dapr/credentials/trustAnchors.pem"
            - "--issuer-certificate-file=/var/run/dapr/credentials/issuerCert.pem"
            - "--issuer-key-file=/var/run/dapr/credentials/issuerKey.pem"
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: DAPR_API_TOKEN
              valueFrom:
                secretKeyRef:
                  name: dapr-api-token
                  key: dapr-api-token
          ports:
            - containerPort: 80
              name: http
              protocol: TCP
            - containerPort: 50001
              name: grpc
              protocol: TCP
            - containerPort: 50002
              name: internal-grpc
              protocol: TCP
            - containerPort: 9090
              name: metrics
              protocol: TCP
            - containerPort: 4000
              name: injector
              protocol: TCP
            - containerPort: 4000
              name: webhook
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /healthz
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 5
          readinessProbe:
            httpGet:
              path: /healthz
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "200m"
          volumeMounts:
            - name: dapr-trust-bundle
              mountPath: /var/run/dapr/credentials
              readOnly: true
          workingDir: /home/nonroot
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
      volumes:
        - name: dapr-trust-bundle
          secret:
            secretName: dapr-trust-bundle
      restartPolicy: Always
      terminationGracePeriodSeconds: 30
      securityContext:
        fsGroup: 1001

---
# Dapr Sentry (Certificate Management)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dapr-sentry
  namespace: dapr-system
  labels:
    app: dapr-sentry
    app.kubernetes.io/name: dapr-sentry
    app.kubernetes.io/part-of: todo-chatbot
    app.kubernetes.io/version: "1.12.0"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dapr-sentry
  template:
    metadata:
      labels:
        app: dapr-sentry
      annotations:
        dapr.io/enabled: "false"  # Don't inject Dapr into itself
    spec:
      serviceAccountName: dapr-sentry
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
      containers:
        - name: dapr-sentry
          image: "docker.io/daprio/dapr:1.12.0"
          imagePullPolicy: IfNotPresent
          command: ["/usr/local/bin/daprd"]
          args:
            - "--mode=kubernetes"
            - "--dapr-http-port=80"
            - "--dapr-grpc-port=50001"
            - "--dapr-internal-grpc-port=50002"
            - "--app-port=8080"
            - "--app-id=dapr-sentry"
            - "--control-plane-address=dapr-api.dapr-system.svc.cluster.local:80"
            - "--log-level=info"
            - "--log-as-json"
            - "--metrics-port=9090"
            - "--enable-metrics=true"
            - "--namespace=dapr-system"
            - "--image-pull-policy=Always"
            - "--enable-mtls=true"
            - "--issuer-timeout=30s"
            - "--issuer-certificate-output-path=/var/run/dapr/credentials/issuer.crt"
            - "--issuer-key-output-path=/var/run/dapr/credentials/issuer.key"
            - "--trust-anchors-output-path=/var/run/dapr/credentials/trust.crt"
            - "--issuer-credentials-volume-path=/var/run/dapr/issuer"
            - "--issuer-credentials-volume-mount-path=/var/run/dapr/issuer"
            - "--rotation-interval=24h"
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: DAPR_API_TOKEN
              valueFrom:
                secretKeyRef:
                  name: dapr-api-token
                  key: dapr-api-token
          ports:
            - containerPort: 80
              name: http
              protocol: TCP
            - containerPort: 50001
              name: grpc
              protocol: TCP
            - containerPort: 50002
              name: internal-grpc
              protocol: TCP
            - containerPort: 9090
              name: metrics
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /healthz
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 5
          readinessProbe:
            httpGet:
              path: /healthz
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "200m"
          volumeMounts:
            - name: dapr-trust-bundle
              mountPath: /var/run/dapr/credentials
              readOnly: false
            - name: dapr-issuer-credentials
              mountPath: /var/run/dapr/issuer
              readOnly: true
          workingDir: /home/nonroot
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
      volumes:
        - name: dapr-trust-bundle
          secret:
            secretName: dapr-trust-bundle
            optional: true
        - name: dapr-issuer-credentials
          secret:
            secretName: dapr-issuer-credentials
      restartPolicy: Always
      terminationGracePeriodSeconds: 30
      securityContext:
        fsGroup: 1001

---
# Dapr Placement (Actor Placement)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dapr-placement-server
  namespace: dapr-system
  labels:
    app: dapr-placement-server
    app.kubernetes.io/name: dapr-placement-server
    app.kubernetes.io/part-of: todo-chatbot
    app.kubernetes.io/version: "1.12.0"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dapr-placement-server
  template:
    metadata:
      labels:
        app: dapr-placement-server
      annotations:
        dapr.io/enabled: "false"  # Don't inject Dapr into itself
    spec:
      serviceAccountName: dapr-placement-server
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
      containers:
        - name: dapr-placement
          image: "docker.io/daprio/dapr:1.12.0"
          imagePullPolicy: IfNotPresent
          command: ["/usr/local/bin/daprd"]
          args:
            - "--mode=kubernetes"
            - "--dapr-http-port=80"
            - "--dapr-grpc-port=50001"
            - "--dapr-internal-grpc-port=50002"
            - "--app-port=8080"
            - "--app-id=dapr-placement-server"
            - "--control-plane-address=dapr-api.dapr-system.svc.cluster.local:80"
            - "--log-level=info"
            - "--log-as-json"
            - "--metrics-port=9090"
            - "--enable-metrics=true"
            - "--namespace=dapr-system"
            - "--image-pull-policy=Always"
            - "--enable-mtls=true"
            - "--placement-host-address=dapr-placement-server.dapr-system.svc.cluster.local"
            - "--placement-port=50005"
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: DAPR_API_TOKEN
              valueFrom:
                secretKeyRef:
                  name: dapr-api-token
                  key: dapr-api-token
          ports:
            - containerPort: 80
              name: http
              protocol: TCP
            - containerPort: 50001
              name: grpc
              protocol: TCP
            - containerPort: 50002
              name: internal-grpc
              protocol: TCP
            - containerPort: 9090
              name: metrics
              protocol: TCP
            - containerPort: 50005
              name: placement
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /healthz
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 5
          readinessProbe:
            httpGet:
              path: /healthz
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "200m"
          workingDir: /home/nonroot
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
      restartPolicy: Always
      terminationGracePeriodSeconds: 30
      securityContext:
        fsGroup: 1001

---
# Dapr Placement Service
apiVersion: v1
kind: Service
metadata:
  name: dapr-placement-server
  namespace: dapr-system
  labels:
    app: dapr-placement-server
    app.kubernetes.io/name: dapr-placement-server
    app.kubernetes.io/part-of: todo-chatbot
    app.kubernetes.io/version: "1.12.0"
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 80
      targetPort: http
      protocol: TCP
    - name: grpc
      port: 50001
      targetPort: grpc
      protocol: TCP
    - name: internal-grpc
      port: 50002
      targetPort: internal-grpc
      protocol: TCP
    - name: metrics
      port: 9090
      targetPort: metrics
      protocol: TCP
    - name: placement
      port: 50005
      targetPort: placement
      protocol: TCP
  selector:
    app: dapr-placement-server

---
# Dapr Sidecar Injector Service
apiVersion: v1
kind: Service
metadata:
  name: dapr-sidecar-injector
  namespace: dapr-system
  labels:
    app: dapr-sidecar-injector
    app.kubernetes.io/name: dapr-sidecar-injector
    app.kubernetes.io/part-of: todo-chatbot
    app.kubernetes.io/version: "1.12.0"
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 80
      targetPort: http
      protocol: TCP
    - name: grpc
      port: 50001
      targetPort: grpc
      protocol: TCP
    - name: internal-grpc
      port: 50002
      targetPort: internal-grpc
      protocol: TCP
    - name: metrics
      port: 9090
      targetPort: metrics
      protocol: TCP
    - name: injector
      port: 4000
      targetPort: injector
      protocol: TCP
    - name: webhook
      port: 4000
      targetPort: webhook
      protocol: TCP
  selector:
    app: dapr-sidecar-injector

---
# Dapr Sentry Service
apiVersion: v1
kind: Service
metadata:
  name: dapr-sentry
  namespace: dapr-system
  labels:
    app: dapr-sentry
    app.kubernetes.io/name: dapr-sentry
    app.kubernetes.io/part-of: todo-chatbot
    app.kubernetes.io/version: "1.12.0"
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 80
      targetPort: http
      protocol: TCP
    - name: grpc
      port: 50001
      targetPort: grpc
      protocol: TCP
    - name: internal-grpc
      port: 50002
      targetPort: internal-grpc
      protocol: TCP
    - name: metrics
      port: 9090
      targetPort: metrics
      protocol: TCP
  selector:
    app: dapr-sentry

---
# Dapr Webhooks and Certificates
---
# Dapr Webhook Certificates
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: dapr-webhook
  namespace: dapr-system
  labels:
    app.kubernetes.io/name: dapr-webhook
    app.kubernetes.io/part-of: todo-chatbot
spec:
  secretName: dapr-webhook-certs
  duration: 2160h # 90d
  renewBefore: 360h # 15d
  subject:
    organizations:
      - dapr.dev
  commonName: dapr-webhook.dapr-system.svc.cluster.local
  dnsNames:
    - dapr-webhook.dapr-system.svc.cluster.local
    - dapr-webhook.dapr-system.svc
    - dapr-webhook.dapr-system
  issuerRef:
    name: dapr-selfsigned-issuer
    kind: Issuer
---
# Dapr Self-Signed Issuer
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: dapr-selfsigned-issuer
  namespace: dapr-system
  labels:
    app.kubernetes.io/name: dapr-selfsigned-issuer
    app.kubernetes.io/part-of: todo-chatbot
spec:
  selfSigned: {}
---
# Dapr CA Issuer
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: dapr-ca-issuer
  namespace: dapr-system
  labels:
    app.kubernetes.io/name: dapr-ca-issuer
    app.kubernetes.io/part-of: todo-chatbot
spec:
  ca:
    secretName: dapr-ca
---
# Dapr CA Certificate
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: dapr-ca
  namespace: dapr-system
  labels:
    app.kubernetes.io/name: dapr-ca
    app.kubernetes.io/part-of: todo-chatbot
spec:
  secretName: dapr-ca
  duration: 87600h # 10y
  renewBefore: 8760h # 1y
  subject:
    organizations:
      - dapr.dev
  isCA: true
  commonName: dapr-dev-ca
  keyAlgorithm: rsa
  keySize: 4096
  issuerRef:
    name: dapr-selfsigned-issuer
    kind: Issuer

---
# Dapr Webhook Configurations
---
# Dapr Sidecar Injector Webhook
apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  name: dapr-sidecar-injector-webhook
  labels:
    app.kubernetes.io/name: dapr-sidecar-injector-webhook
    app.kubernetes.io/part-of: todo-chatbot
webhooks:
  - name: sidecar-injector.dapr.io
    clientConfig:
      service:
        name: dapr-sidecar-injector
        namespace: dapr-system
        path: "/mutate/pods"
      caBundle: Cg==
    admissionReviewVersions: ["v1", "v1beta1"]
    sideEffects: None
    rules:
      - operations: ["CREATE"]
        apiGroups: [""]
        apiVersions: ["v1"]
        resources: ["pods"]
    namespaceSelector:
      matchLabels:
        dapr.io/enabled: "true"
    failurePolicy: Fail
    timeoutSeconds: 30
---
# Dapr Config Validator Webhook
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  name: dapr-config-validator-webhook
  labels:
    app.kubernetes.io/name: dapr-config-validator-webhook
    app.kubernetes.io/part-of: todo-chatbot
webhooks:
  - name: config-validator.dapr.io
    clientConfig:
      service:
        name: dapr-sidecar-injector
        namespace: dapr-system
        path: "/validate/dapr/v1alpha1/configuration"
      caBundle: Cg==
    admissionReviewVersions: ["v1", "v1beta1"]
    sideEffects: None
    rules:
      - operations: ["CREATE", "UPDATE"]
        apiGroups: ["dapr.io"]
        apiVersions: ["v1alpha1"]
        resources: ["configurations"]
    failurePolicy: Fail
    timeoutSeconds: 30
  - name: component-validator.dapr.io
    clientConfig:
      service:
        name: dapr-sidecar-injector
        namespace: dapr-system
        path: "/validate/dapr/v1alpha1/component"
      caBundle: Cg==
    admissionReviewVersions: ["v1", "v1beta1"]
    sideEffects: None
    rules:
      - operations: ["CREATE", "UPDATE"]
        apiGroups: ["dapr.io"]
        apiVersions: ["v1alpha1"]
        resources: ["components"]
    failurePolicy: Fail
    timeoutSeconds: 30

---
# Dapr RBAC Configuration
---
# Dapr Operator ServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: dapr-operator
  namespace: dapr-system
  labels:
    app.kubernetes.io/name: dapr-operator
    app.kubernetes.io/part-of: todo-chatbot
---
# Dapr Sidecar Injector ServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: dapr-sidecar-injector
  namespace: dapr-system
  labels:
    app.kubernetes.io/name: dapr-sidecar-injector
    app.kubernetes.io/part-of: todo-chatbot
---
# Dapr Sentry ServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: dapr-sentry
  namespace: dapr-system
  labels:
    app.kubernetes.io/name: dapr-sentry
    app.kubernetes.io/part-of: todo-chatbot
---
# Dapr Placement Server ServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: dapr-placement-server
  namespace: dapr-system
  labels:
    app.kubernetes.io/name: dapr-placement-server
    app.kubernetes.io/part-of: todo-chatbot
---
# Dapr Control Plane ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: dapr-operator
  labels:
    app.kubernetes.io/name: dapr-operator
    app.kubernetes.io/part-of: todo-chatbot
rules:
  - apiGroups: [""]
    resources: ["configmaps", "secrets", "services", "endpoints", "pods", "namespaces"]
    verbs: ["*"]
  - apiGroups: ["apps"]
    resources: ["deployments", "replicasets"]
    verbs: ["*"]
  - apiGroups: ["extensions"]
    resources: ["deployments", "replicasets"]
    verbs: ["*"]
  - apiGroups: ["dapr.io"]
    resources: ["components", "configurations", "subscriptions", "resiliencies"]
    verbs: ["*"]
  - apiGroups: ["admissionregistration.k8s.io"]
    resources: ["mutatingwebhookconfigurations", "validatingwebhookconfigurations"]
    verbs: ["*"]
  - apiGroups: ["certificates.k8s.io"]
    resources: ["certificatesigningrequests"]
    verbs: ["*"]
  - apiGroups: ["cert-manager.io"]
    resources: ["certificates"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
---
# Dapr Operator ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: dapr-operator
  labels:
    app.kubernetes.io/name: dapr-operator
    app.kubernetes.io/part-of: todo-chatbot
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: dapr-operator
subjects:
  - kind: ServiceAccount
    name: dapr-operator
    namespace: dapr-system
---
# Dapr Sidecar Injector ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: dapr-sidecar-injector
  labels:
    app.kubernetes.io/name: dapr-sidecar-injector
    app.kubernetes.io/part-of: todo-chatbot
rules:
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch", "update", "patch"]
  - apiGroups: ["dapr.io"]
    resources: ["configurations"]
    verbs: ["get", "list", "watch"]
---
# Dapr Sidecar Injector ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: dapr-sidecar-injector
  labels:
    app.kubernetes.io/name: dapr-sidecar-injector
    app.kubernetes.io/part-of: todo-chatbot
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: dapr-sidecar-injector
subjects:
  - kind: ServiceAccount
    name: dapr-sidecar-injector
    namespace: dapr-system
---
# Dapr Sentry ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: dapr-sentry
  labels:
    app.kubernetes.io/name: dapr-sentry
    app.kubernetes.io/part-of: todo-chatbot
rules:
  - apiGroups: ["certificates.k8s.io"]
    resources: ["certificatesigningrequests"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: ["certificates.k8s.io"]
    resources: ["certificatesigningrequests/status"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
---
# Dapr Sentry ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: dapr-sentry
  labels:
    app.kubernetes.io/name: dapr-sentry
    app.kubernetes.io/part-of: todo-chatbot
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: dapr-sentry
subjects:
  - kind: ServiceAccount
    name: dapr-sentry
    namespace: dapr-system
---
# Dapr Placement Server ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: dapr-placement-server
  labels:
    app.kubernetes.io/name: dapr-placement-server
    app.kubernetes.io/part-of: todo-chatbot
rules:
  - apiGroups: [""]
    resources: ["pods", "endpoints"]
    verbs: ["get", "list", "watch"]
---
# Dapr Placement Server ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: dapr-placement-server
  labels:
    app.kubernetes.io/name: dapr-placement-server
    app.kubernetes.io/part-of: todo-chatbot
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: dapr-placement-server
subjects:
  - kind: ServiceAccount
    name: dapr-placement-server
    namespace: dapr-system

---
# Dapr API Token Secret
apiVersion: v1
kind: Secret
metadata:
  name: dapr-api-token
  namespace: dapr-system
  labels:
    app.kubernetes.io/name: dapr-api-token
    app.kubernetes.io/part-of: todo-chatbot
type: Opaque
data:
  dapr-api-token: <base64-encoded-token>

# Note: Replace <base64-encoded-token> with a base64 encoded random string
# Generate with: echo -n "your-random-token" | base64