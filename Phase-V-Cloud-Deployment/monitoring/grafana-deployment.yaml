# Phase V: Enterprise Cloud Deployment
# Grafana Deployment for Visualization
#
# [Task]: T042, T047
# [From]: speckit.specify ยง3.5, speckit.plan ยง2.5

---
# Grafana ConfigMap for Dashboards
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards
  namespace: monitoring
  labels:
    app.kubernetes.io/name: grafana-dashboards
    app.kubernetes.io/part-of: todo-chatbot
    grafana_dashboard: "1"
data:
  # Overview Dashboard
  overview.json: |
    {
      "dashboard": {
        "title": "Todo Chatbot Overview",
        "uid": "overview",
        "tags": ["todo-chatbot", "overview"],
        "timezone": "browser",
        "refresh": "30s",
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "panels": [
          {
            "id": 1,
            "title": "Request Rate",
            "type": "graph",
            "gridPos": {"x": 0, "y": 0, "w": 12, "h": 8},
            "targets": [
              {
                "expr": "sum(rate(http_requests_total[5m])) by (pod)",
                "legendFormat": "{{pod}}"
              }
            ],
            "yaxes": [
              {"format": "reqps", "min": 0},
              {"format": "short"}
            ]
          },
          {
            "id": 2,
            "title": "Error Rate",
            "type": "graph",
            "gridPos": {"x": 12, "y": 0, "w": 12, "h": 8},
            "targets": [
              {
                "expr": "sum(rate(http_requests_total{status=~\"5..\"}[5m])) by (pod)",
                "legendFormat": "{{pod}}"
              }
            ],
            "yaxes": [
              {"format": "reqps", "min": 0},
              {"format": "short"}
            ]
          },
          {
            "id": 3,
            "title": "P95 Latency",
            "type": "graph",
            "gridPos": {"x": 0, "y": 8, "w": 12, "h": 8},
            "targets": [
              {
                "expr": "histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (pod, le))",
                "legendFormat": "{{pod}}"
              }
            ],
            "yaxes": [
              {"format": "s", "min": 0},
              {"format": "short"}
            ]
          },
          {
            "id": 4,
            "title": "Active Users",
            "type": "stat",
            "gridPos": {"x": 12, "y": 8, "w": 6, "h": 4},
            "targets": [
              {
                "expr": "sum(user_sessions_active)",
                "legendFormat": "Active Users"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "color": {"mode": "thresholds"},
                "mappings": [],
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"color": "red", "value": null},
                    {"color": "yellow", "value": 10},
                    {"color": "green", "value": 100}
                  ]
                }
              }
            }
          },
          {
            "id": 5,
            "title": "Tasks Completed",
            "type": "stat",
            "gridPos": {"x": 18, "y": 8, "w": 6, "h": 4},
            "targets": [
              {
                "expr": "sum(todo_tasks_completed_total)",
                "legendFormat": "Completed"
              }
            ]
          },
          {
            "id": 6,
            "title": "Pod Status",
            "type": "table",
            "gridPos": {"x": 0, "y": 16, "w": 24, "h": 8},
            "targets": [
              {
                "expr": "kube_pod_status_ready{namespace=\"default\"}",
                "format": "table",
                "instant": true
              }
            ],
            "transformations": [
              {
                "id": "organize",
                "options": {
                  "columns": ["Name", "Ready", "Status", "Restarts"],
                  "renameByName": {
                    "pod": "Name",
                    "value": "Ready",
                    "condition": "Status"
                  }
                }
              }
            ]
          }
        ]
      }
    }

  # Application Performance Dashboard
  app-performance.json: |
    {
      "dashboard": {
        "title": "Application Performance",
        "uid": "app-performance",
        "tags": ["todo-chatbot", "performance"],
        "timezone": "browser",
        "refresh": "10s",
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "panels": [
          {
            "id": 1,
            "title": "Request Duration Distribution",
            "type": "heatmap",
            "gridPos": {"x": 0, "y": 0, "w": 12, "h": 8},
            "targets": [
              {
                "expr": "sum(rate(http_request_duration_seconds_bucket[5m])) by (le)",
                "legendFormat": "{{le}}"
              }
            ]
          },
          {
            "id": 2,
            "title": "Throughput by Endpoint",
            "type": "graph",
            "gridPos": {"x": 12, "y": 0, "w": 12, "h": 8},
            "targets": [
              {
                "expr": "sum(rate(http_requests_total[5m])) by (endpoint, method)",
                "legendFormat": "{{endpoint}} - {{method}}"
              }
            ]
          },
          {
            "id": 3,
            "title": "Error Rate by Status Code",
            "type": "graph",
            "gridPos": {"x": 0, "y": 8, "w": 12, "h": 8},
            "targets": [
              {
                "expr": "sum(rate(http_requests_total{status=~\"5..\"}[5m])) by (status)",
                "legendFormat": "Status {{status}}"
              }
            ]
          },
          {
            "id": 4,
            "title": "Database Query Time",
            "type": "graph",
            "gridPos": {"x": 12, "y": 8, "w": 12, "h": 8},
            "targets": [
              {
                "expr": "histogram_quantile(0.95, sum(rate(database_query_duration_seconds_bucket[5m])) by (operation, le))",
                "legendFormat": "{{operation}}"
              }
            ]
          }
        ]
      }
    }

  # Kafka Dashboard
  kafka.json: |
    {
      "dashboard": {
        "title": "Kafka Metrics",
        "uid": "kafka",
        "tags": ["kafka", "messaging"],
        "timezone": "browser",
        "refresh": "30s",
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "panels": [
          {
            "id": 1,
            "title": "Message Rate",
            "type": "graph",
            "gridPos": {"x": 0, "y": 0, "w": 12, "h": 8},
            "targets": [
              {
                "expr": "sum(rate(kafka_server_broker_topic_messages_in_per_sec[5m])) by (topic)",
                "legendFormat": "{{topic}}"
              }
            ]
          },
          {
            "id": 2,
            "title": "Under-Replicated Partitions",
            "type": "stat",
            "gridPos": {"x": 12, "y": 0, "w": 6, "h": 4},
            "targets": [
              {
                "expr": "sum(kafka_server_replicamanager_underreplicatedpartitions)",
                "legendFormat": "Under-Replicated"
              }
            ]
          },
          {
            "id": 3,
            "title": "Offline Partitions",
            "type": "stat",
            "gridPos": {"x": 18, "y": 0, "w": 6, "h": 4},
            "targets": [
              {
                "expr": "sum(kafka_controller_kafkacontroller_offlinepartitionscount)",
                "legendFormat": "Offline"
              }
            ]
          },
          {
            "id": 4,
            "title": "Request Rate",
            "type": "graph",
            "gridPos": {"x": 0, "y": 8, "w": 12, "h": 8},
            "targets": [
              {
                "expr": "sum(rate(kafka_server_broker_topic_requests_per_sec[5m])) by (request)",
                "legendFormat": "{{request}}"
              }
            ]
          },
          {
            "id": 5,
            "title": "Partition Count",
            "type": "graph",
            "gridPos": {"x": 12, "y": 8, "w": 12, "h": 8},
            "targets": [
              {
                "expr": "kafka_server_replica_manager_partition_count",
                "legendFormat": "Total Partitions"
              },
              {
                "expr": "kafka_server_replica_manager_leader_count",
                "legendFormat": "Leader Partitions"
              }
            ]
          }
        ]
      }
    }

  # Infrastructure Dashboard
  infrastructure.json: |
    {
      "dashboard": {
        "title": "Infrastructure Overview",
        "uid": "infrastructure",
        "tags": ["infrastructure", "kubernetes"],
        "timezone": "browser",
        "refresh": "30s",
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "panels": [
          {
            "id": 1,
            "title": "CPU Usage",
            "type": "graph",
            "gridPos": {"x": 0, "y": 0, "w": 12, "h": 8},
            "targets": [
              {
                "expr": "sum(rate(container_cpu_usage_seconds_total[5m])) by (pod)",
                "legendFormat": "{{pod}}"
              }
            ]
          },
          {
            "id": 2,
            "title": "Memory Usage",
            "type": "graph",
            "gridPos": {"x": 12, "y": 0, "w": 12, "h": 8},
            "targets": [
              {
                "expr": "sum(container_memory_working_set_bytes) by (pod)",
                "legendFormat": "{{pod}}",
                "unit": "bytes"
              }
            ]
          },
          {
            "id": 3,
            "title": "Pod Count by Status",
            "type": "piechart",
            "gridPos": {"x": 0, "y": 8, "w": 8, "h": 8},
            "targets": [
              {
                "expr": "count(kube_pod_status_phase{namespace=\"default\"}) by (phase)",
                "legendFormat": "{{phase}}"
              }
            ]
          },
          {
            "id": 4,
            "title": "Network I/O",
            "type": "graph",
            "gridPos": {"x": 8, "y": 8, "w": 16, "h": 8},
            "targets": [
              {
                "expr": "sum(rate(container_network_receive_bytes_total[5m])) by (pod)",
                "legendFormat": "{{pod}} - RX"
              },
              {
                "expr": "sum(rate(container_network_transmit_bytes_total[5m])) by (pod)",
                "legendFormat": "{{pod}} - TX"
              }
            ]
          }
        ]
      }
    }

---
# Grafana Datasources ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  namespace: monitoring
  labels:
    app.kubernetes.io/name: grafana-datasources
    app.kubernetes.io/part-of: todo-chatbot
data:
  datasources.yml: |
    apiVersion: 1
    datasources:
      - name: Prometheus
        type: prometheus
        access: proxy
        url: http://prometheus:9090
        isDefault: true
        jsonData:
          timeInterval: 15s
          httpMethod: GET
        editable: false
      - name: Loki
        type: loki
        access: proxy
        url: http://loki:3100
        jsonData:
          maxLines: 1000
        editable: false
      - name: Jaeger
        type: jaeger
        access: proxy
        url: http://jaeger-query:16686
        jsonData:
          tracesToLogs:
            datasourceUid: "loki"
        editable: false

---
# Grafana Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: monitoring
  labels:
    app.kubernetes.io/name: grafana
    app.kubernetes.io/part-of: todo-chatbot
    app.kubernetes.io/version: "10.0.0"
spec:
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: grafana
  template:
    metadata:
      labels:
        app.kubernetes.io/name: grafana
        app.kubernetes.io/part-of: todo-chatbot
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "3000"
    spec:
      serviceAccountName: grafana
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
      containers:
        - name: grafana
          image: grafana/grafana:10.0.0
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 3000
              name: http
              protocol: TCP
            - containerPort: 9090
              name: metrics
              protocol: TCP
          env:
            - name: GF_SECURITY_ADMIN_USER
              valueFrom:
                secretKeyRef:
                  name: grafana-credentials
                  key: admin-user
            - name: GF_SECURITY_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: grafana-credentials
                  key: admin-password
            - name: GF_USERS_ALLOW_SIGN_UP
              value: "false"
            - name: GF_USERS_AUTO_ASSIGN_ORG
              value: "true"
            - name: GF_USERS_AUTO_ASSIGN_ORG_ROLE
              value: "Viewer"
            - name: GF_AUTH_ANONYMOUS_ENABLED
              value: "false"
            - name: GF_AUTH_DISABLE_LOGIN_FORM
              value: "false"
            - name: GF_SERVER_ROOT_URL
              value: "https://grafana.todo-chatbot.example.com"
            - name: GF_SERVER_SERVE_FROM_SUB_PATH
              value: "false"
            - name: GF_LOG_MODE
              value: "console"
            - name: GF_LOG_LEVEL
              value: "info"
            - name: GF_PATHS_DATA
              value: "/var/lib/grafana"
            - name: GF_PATHS_LOGS
              value: "/var/log/grafana"
            - name: GF_PATHS_PLUGINS
              value: "/var/lib/grafana/plugins"
            - name: GF_PATHS_PROVISIONING
              value: "/etc/grafana/provisioning"
          volumeMounts:
            - name: grafana-storage
              mountPath: /var/lib/grafana
            - name: grafana-datasources
              mountPath: /etc/grafana/provisioning/datasources
              readOnly: true
            - name: grafana-dashboards
              mountPath: /etc/grafana/provisioning/dashboards
              readOnly: true
            - name: grafana-config
              mountPath: /etc/grafana
          livenessProbe:
            httpGet:
              path: /api/health
              port: http
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 5
          readinessProbe:
            httpGet:
              path: /api/health
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 10
            failureThreshold: 3
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "1Gi"
              cpu: "500m"
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: true
      volumes:
        - name: grafana-storage
          persistentVolumeClaim:
            claimName: grafana-pvc
        - name: grafana-datasources
          configMap:
            name: grafana-datasources
        - name: grafana-dashboards
          configMap:
            name: grafana-dashboards
        - name: grafana-config
          configMap:
            name: grafana-config
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                        - grafana
                topologyKey: kubernetes.io/hostname

---
# Grafana Service
apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: monitoring
  labels:
    app.kubernetes.io/name: grafana
    app.kubernetes.io/part-of: todo-chatbot
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: grafana

---
# Grafana Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: grafana
  namespace: monitoring
  labels:
    app.kubernetes.io/name: grafana
    app.kubernetes.io/part-of: todo-chatbot
  annotations:
    kubernetes.io/ingress.class: "nginx"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/auth-type: "basic"
    nginx.ingress.kubernetes.io/auth-secret: "grafana-basic-auth"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
spec:
  tls:
    - hosts:
        - grafana.todo-chatbot.example.com
      secretName: grafana-tls
  rules:
    - host: grafana.todo-chatbot.example.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: grafana
                port:
                  number: 80

---
# Grafana Persistent Volume Claim
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: grafana-pvc
  namespace: monitoring
  labels:
    app.kubernetes.io/name: grafana-pvc
    app.kubernetes.io/part-of: todo-chatbot
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: do-block-storage

---
# Grafana Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: grafana
  namespace: monitoring
  labels:
    app.kubernetes.io/name: grafana
    app.kubernetes.io/part-of: todo-chatbot

---
# Grafana RBAC
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: grafana
  namespace: monitoring
  labels:
    app.kubernetes.io/name: grafana
    app.kubernetes.io/part-of: todo-chatbot
rules:
  - apiGroups: [""]
    resources: ["configmaps", "secrets"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["pods", "services"]
    verbs: ["get", "list"]

---
# Grafana Role Binding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: grafana
  namespace: monitoring
  labels:
    app.kubernetes.io/name: grafana
    app.kubernetes.io/part-of: todo-chatbot
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: grafana
subjects:
  - kind: ServiceAccount
    name: grafana
    namespace: monitoring

---
# Grafana Config (additional settings)
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-config
  namespace: monitoring
  labels:
    app.kubernetes.io/name: grafana-config
    app.kubernetes.io/part-of: todo-chatbot
data:
  grafana.ini: |
    [paths]
    provisioning = /etc/grafana/provisioning

    [server]
    domain = todo-chatbot.example.com
    root_url = %(protocol)s://%(domain)s/

    [security]
    admin_user = ${GF_SECURITY_ADMIN_USER}
    admin_password = ${GF_SECURITY_ADMIN_PASSWORD}
    disable_gravatar = true

    [auth]
    disable_login_form = false
    disable_signout_menu = false

    [users]
    allow_sign_up = false
    auto_assign_org = true
    auto_assign_org_role = Viewer

    [analytics]
    check_for_updates = false
    feedback_links_enabled = false

    [metrics]
    enabled = true
    graphite_endpoint = localhost:8888

    [tracing.jaeger]
    enabled = false

    [log]
    mode = console
    level = info

    [log.console]
    format = console

---
# Basic Auth Secret for Ingress
apiVersion: v1
kind: Secret
metadata:
  name: grafana-basic-auth
  namespace: monitoring
  type: Opaque
data:
  auth: <base64-encoded-htpasswd>

---
# Grafana Credentials Secret
apiVersion: v1
kind: Secret
metadata:
  name: grafana-credentials
  namespace: monitoring
  type: Opaque
data:
  admin-user: <base64-encoded-admin-user>
  admin-password: <base64-encoded-admin-password>

---
# Grafana Pod Disruption Budget
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: grafana-pdb
  namespace: monitoring
  labels:
    app.kubernetes.io/name: grafana-pdb
    app.kubernetes.io/part-of: todo-chatbot
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: grafana
