# Phase V: Enterprise Cloud Deployment
# GitHub Actions CI/CD Pipeline
#
# [Task]: T031-T040
# [From]: speckit.specify ยง3.4, speckit.plan ยง2.4

---
name: Todo Chatbot CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'release/**'
    paths:
      - 'Phase-II-Full-Stack-Web-Application/**'
      - 'Phase-III-AI-Chatbot/**'
      - 'Phase-IV-Local-K8s-Deployment/**'
      - 'Phase-V-Cloud-Deployment/**'
      - '.github/workflows/**'
      - '*.py'
      - '*.yaml'
      - 'Dockerfile*'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment (staging|production)'
        required: true
        default: 'staging'
      skip_tests:
        description: 'Skip tests and deploy directly'
        required: false
        default: 'false'
      skip_infra:
        description: 'Skip infrastructure deployment'
        required: false
        default: 'false'

env:
  # Application Configuration
  APP_NAME: 'todo-chatbot'
  FRONTEND_DIR: 'Phase-II-Full-Stack-Web-Application/frontend'
  BACKEND_DIR: 'Phase-III-AI-Chatbot/backend'
  K8S_DIR: 'Phase-IV-Local-K8s-Deployment'
  TERRAFORM_DIR: 'Phase-V-Cloud-Deployment/terraform'
  HELM_DIR: 'Phase-IV-Local-K8s-Deployment/helm/todo-chatbot'

  # Docker Configuration
  REGISTRY: 'docker.io'
  IMAGE_FRONTEND: '${{ secrets.DOCKERHUB_USERNAME }}/todo-chatbot-frontend'
  IMAGE_BACKEND: '${{ secrets.DOCKERHUB_USERNAME }}/todo-chatbot-backend'

  # DigitalOcean Configuration
  DO_REGION: 'nyc1'

permissions:
  contents: read
  id-token: write
  actions: read
  checks: write
  deployments: write
  packages: write
  pull-requests: write
  repository-projects: write
  security-events: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # =========================================================================
  # CODE QUALITY - Linting and Static Analysis
  # =========================================================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    outputs:
      frontend_ready: ${{ stepsFrontend.status }}
      backend_ready: ${{ stepsBackend.status }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ${{ env.FRONTEND_DIR }}/package-lock.json

      # Frontend Quality Checks
      - name: Frontend Linting
        id: stepsFrontend
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          echo "Running frontend linting..."
          npm ci
          npx eslint . --ext .js,.jsx,.ts,.tsx --max-warnings 0 || true
          npx prettier --check . || true

      # Backend Quality Checks
      - name: Backend Linting & Type Checking
        id: stepsBackend
        working-directory: ${{ env.BACKEND_DIR }}
        run: |
          echo "Running backend linting..."
          python -m pip install --upgrade pip
          pip install ruff mypy
          ruff check . || true
          mypy . --ignore-missing-imports || true

      # Security Scanning
      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy Scan Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # =========================================================================
  # BACKEND TESTS
  # =========================================================================
  test-backend:
    name: Backend Tests
    runs-on: ubuntu-latest
    needs: code-quality
    if: always() && needs.code-quality.result == 'success'
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        working-directory: ${{ env.BACKEND_DIR }}
        run: |
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Run Database Migrations
        working-directory: ${{ env.BACKEND_DIR }}
        run: |
          export DATABASE_URL="postgresql://test_user:test_password@localhost:5432/test_db"
          export REDIS_HOST="localhost"
          python -m alembic upgrade head

      - name: Run Unit Tests
        working-directory: ${{ env.BACKEND_DIR }}
        run: |
          export DATABASE_URL="postgresql://test_user:test_password@localhost:5432/test_db"
          export REDIS_HOST="localhost"
          pytest tests/ -v --cov=app --cov-report=xml --cov-report=term-missing

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: backend
          name: backend-coverage

      - name: Generate Test Report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Backend Tests
          path: pytest-results.xml
          reporter: python-pytest
          fail-on-error: false

  # =========================================================================
  # FRENDEND TESTS
  # =========================================================================
  test-frontend:
    name: Frontend Tests
    runs-on: ubuntu-latest
    needs: code-quality
    if: always() && needs.code-quality.result == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ${{ env.FRONTEND_DIR }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ env.FRONTEND_DIR }}
        run: npm ci

      - name: Run Type Check
        working-directory: ${{ env.FRONTEND_DIR }}
        run: npx tsc --noEmit

      - name: Run Unit Tests
        working-directory: ${{ env.FRONTEND_DIR }}
        run: npm test -- --coverage --passWithNoTests

      - name: Run E2E Tests
        working-directory: ${{ env.FRONTEND_DIR }}
        run: npm run test:e2e || true

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          flags: frontend
          name: frontend-coverage

  # =========================================================================
  # BUILD - Docker Images
  # =========================================================================
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    if: always() && needs.test-backend.result == 'success' && needs.test-frontend.result == 'success'
    outputs:
      frontend_digest: ${{ steps.build_frontend.outputs.digest }}
      backend_digest: ${{ steps.build_backend.outputs.digest }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata for Frontend
        id: meta_frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_FRONTEND }}
          tags: |
            type=sha
            type=ref,event=branch
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ github.sha }}

      - name: Extract metadata for Backend
        id: meta_backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_BACKEND }}
          tags: |
            type=sha
            type=ref,event=branch
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ github.sha }}

      - name: Build and push Frontend
        id: build_frontend
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.FRONTEND_DIR }}
          push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
          tags: ${{ steps.meta_frontend.outputs.tags }}
          labels: ${{ steps.meta_frontend.outputs.labels }}
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend
          load: true

      - name: Build and push Backend
        id: build_backend
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.BACKEND_DIR }}
          push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
          tags: ${{ steps.meta_backend.outputs.tags }}
          labels: ${{ steps.meta_backend.outputs.labels }}
          cache-from: type=gha,scope=backend
          cache-to: type=gha,mode=max,scope=backend
          load: true

      - name: Scan Frontend Image for Vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.IMAGE_FRONTEND }}:${{ github.sha }}'
          severity: 'CRITICAL,HIGH'
          format: 'sarif'
          output: 'trivy-frontend.sarif'

      - name: Scan Backend Image for Vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.IMAGE_BACKEND }}:${{ github.sha }}'
          severity: 'CRITICAL,HIGH'
          format: 'sarif'
          output: 'trivy-backend.sarif'

      - name: Upload Trivy Scan Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-frontend.sarif'
          category: 'frontend-image'

      - name: Upload Trivy Scan Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-backend.sarif'
          category: 'backend-image'

  # =========================================================================
  # TERRAFORM INFRASTRUCTURE
  # =========================================================================
  terraform:
    name: Terraform Infrastructure
    runs-on: ubuntu-latest
    needs: build
    if: always() && needs.build.result == 'success' && github.event_name != 'pull_request'
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}
    defaults:
      run:
        working-directory: ${{ env.TERRAFORM_DIR }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.5.7'

      - name: Setup DigitalOcean Provider
        run: terraform init

      - name: Validate Terraform Configuration
        run: terraform validate

      - name: Plan Terraform Changes
        id: plan
        run: terraform plan -input=false -out=tfplan
        env:
          TF_VAR_do_token: ${{ secrets.DO_TOKEN }}
          TF_VAR_cluster_name: ${{ env.APP_NAME }}-${{ github.event.inputs.environment || 'staging' }}
          TF_VAR_environment: ${{ github.event.inputs.environment || 'staging' }}

      - name: Upload Terraform Plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: tfplan
          retention-days: 7

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const plan = `## Terraform Plan\n\`\`\`\n${fs.readFileSync('tfplan', 'utf8')}\n\`\`\``;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              body: plan
            });

      - name: Apply Terraform Changes
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: terraform apply -input=false tfplan
        env:
          TF_VAR_do_token: ${{ secrets.DO_TOKEN }}
          TF_VAR_cluster_name: ${{ env.APP_NAME }}-${{ github.event.inputs.environment || 'staging' }}
          TF_VAR_environment: ${{ github.event.inputs.environment || 'staging' }}

      - name: Output Cluster Info
        if: always()
        run: |
          terraform output -json > cluster-info.json
          cat cluster-info.json

      - name: Upload Cluster Info
        uses: actions/upload-artifact@v4
        with:
          name: cluster-info
          path: cluster-info.json
          retention-days: 1

  # =========================================================================
  # KUBERNETES DEPLOYMENT
  # =========================================================================
  deploy-k8s:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: [build, terraform]
    if: always() && needs.build.result == 'success' && needs.terraform.result == 'success' && github.event_name != 'pull_request'
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/k8s-set-context@v4
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBECONFIG_STAGING }}

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.12.0'

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Download Cluster Info
        uses: actions/download-artifact@v4
        with:
          name: cluster-info
          path: cluster-info

      - name: Pull latest images
        run: |
          docker pull ${{ env.IMAGE_FRONTEND }}:${{ github.sha }}
          docker pull ${{ env.IMAGE_BACKEND }}:${{ github.sha }}

      - name: Deploy Kafka (Strimzi)
        working-directory: ${{ env.K8S_DIR }}/kafka
        run: |
          kubectl apply -f strimzi-operator.yaml -n kafka
          kubectl apply -f kafka-cluster.yaml -n kafka
          kubectl apply -f topics.yaml -n kafka
          kubectl apply -f kafka-ui.yaml -n kafka

      - name: Deploy Redis
        working-directory: Phase-V-Cloud-Deployment/dapr
        run: |
          kubectl apply -f components.yaml

      - name: Deploy Dapr Control Plane
        working-directory: Phase-V-Cloud-Deployment/dapr
        run: |
          kubectl apply -f dapr-install.yaml

      - name: Deploy Backend
        working-directory: ${{ env.K8S_DIR }}/k8s
        run: |
          kubectl set image deployment/todo-chatbot-backend \
            backend=${{ env.IMAGE_BACKEND }}:${{ github.sha }} \
            -n default
          kubectl rollout status deployment/todo-chatbot-backend -n default --timeout=300s

      - name: Deploy Frontend
        working-directory: ${{ env.K8S_DIR }}/k8s
        run: |
          kubectl set image deployment/todo-chatbot-frontend \
            frontend=${{ env.IMAGE_FRONTEND }}:${{ github.sha }} \
            -n default
          kubectl rollout status deployment/todo-chatbot-frontend -n default --timeout=300s

      - name: Verify Deployment
        run: |
          kubectl get pods -n default
          kubectl get svc -n default
          kubectl get endpoints -n default

      - name: Run Health Checks
        run: |
          curl -f http://${{ secrets.SERVICE_URL }}/api/health || exit 1

  # =========================================================================
  # INTEGRATION TESTS
  # =========================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: deploy-k8s
    if: always() && needs.deploy-k8s.result == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run Integration Tests
        run: |
          pip install requests httpx
          python -c "
          import requests
          import sys

          # Test backend health
          response = requests.get('http://${{ secrets.SERVICE_URL }}/api/health')
          if response.status_code != 200:
              print(f'Backend health check failed: {response.status_code}')
              sys.exit(1)

          # Test API endpoints
          response = requests.get('http://${{ secrets.SERVICE_URL }}/api/tasks')
          if response.status_code != 200:
              print(f'Tasks endpoint failed: {response.status_code}')
              sys.exit(1)

          print('All integration tests passed!')
          "

      - name: Run Load Tests
        uses: jaredpalmer/terranetes-controller@v1
        if: false  # Enable for production
        with:
          command: 'k6 run -e K6_PROMETHEUS_RW_URL=http://prometheus:9090/api/v1/write /tests/load.js'

  # =========================================================================
  # NOTIFICATIONS
  # =========================================================================
  notify:
    name: Notifications
    runs-on: ubuntu-latest
    needs: [deploy-k8s, integration-tests]
    if: always()

    steps:
      - name: Send Slack Notification
        if: always() && github.event_name == 'push'
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          text: 'Todo Chatbot deployment completed!'
          fields: repo,message,commit,author,action,eventName,ref,workflow
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Create Deployment Summary
        uses: actions/github-script@v7
        if: github.event_name == 'push'
        with:
          script: |
            const summary = `
            ## Deployment Summary

            **Status**: ${{ job.status }}
            **Environment**: ${{ github.event.inputs.environment || 'staging' }}
            **Commit**: ${{ github.sha }}
            **Author**: ${{ github.actor }}

            [View Deployment](${{ env.SERVICE_URL }})
            `;
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: summary
            });

  # =========================================================================
  # ROLLBACK (Manual Trigger)
  # =========================================================================
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/k8s-set-context@v4
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBECONFIG_STAGING }}

      - name: Rollback Deployment
        run: |
          kubectl rollout undo deployment/todo-chatbot-backend -n default
          kubectl rollout undo deployment/todo-chatbot-frontend -n default
          kubectl rollout status deployment/todo-chatbot-backend -n default --timeout=300s
          kubectl rollout status deployment/todo-chatbot-frontend -n default --timeout=300s

      - name: Notify Rollback
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          text: 'Todo Chatbot deployment rolled back!'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
